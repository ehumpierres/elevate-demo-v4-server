# Citation System Enhancement PRD

## Project Overview

### Background
Our AI chatbot system currently uses company data from Snowflake (financial, sales, marketing) accessed via Vanna text-to-SQL tool, with business insights processed by an LLM and stored in short-term (20 interactions) and long-term (Mem0) memory modules. 

### Problem Statement
The system lacks the ability to cite hard data sources or prior memories when producing new dialogue, making it difficult for users to verify information or understand the basis of insights.

### Solution Summary
Implement a comprehensive citation pipeline that captures data lineage, enhances memory storage with citation metadata, and provides footnoted responses in the Streamlit UI.

---

## Requirements

### Functional Requirements

#### FR-1: Data Lineage Capture
- **FR-1.1**: Capture and store all SQL queries generated by Vanna
- **FR-1.2**: Store raw query results with source table metadata
- **FR-1.3**: Maintain query execution context (user question, timestamp, session)
- **FR-1.4**: Extract and store source table names from SQL queries

#### FR-2: Enhanced Memory Storage
- **FR-2.1**: Extend short-term memory to include citation metadata
- **FR-2.2**: Enhance Mem0 long-term memory with data source references
- **FR-2.3**: Link insights to their originating queries and data

#### FR-3: Citation Generation
- **FR-3.1**: Generate footnoted citations for hard data references
- **FR-3.2**: Generate footnoted citations for memory/insight references
- **FR-3.3**: Support mixed citations (both data and memory in same response)
- **FR-3.4**: Format citations as footnotes in Streamlit UI

#### FR-4: Response Enhancement
- **FR-4.1**: Modify LLM prompting to include citation instructions
- **FR-4.2**: Inject citation markers into LLM responses
- **FR-4.3**: Store response-citation mappings for audit trails

### Non-Functional Requirements

#### NFR-1: Performance
- **NFR-1.1**: Citation lookup should add <500ms to response time
- **NFR-1.2**: Query result storage should not impact Vanna performance
- **NFR-1.3**: Memory retrieval with citations should maintain current speed

#### NFR-2: Storage
- **NFR-2.1**: Implement 3-month data retention for query results
- **NFR-2.2**: Store all citation data in Snowflake
- **NFR-2.3**: Optimize storage for frequently accessed citation data

#### NFR-3: Reliability
- **NFR-3.1**: Citation system should degrade gracefully if unavailable
- **NFR-3.2**: System should continue functioning if citation storage fails
- **NFR-3.3**: Implement retry logic for citation data retrieval

---

## Technical Architecture

### Database Schema (Snowflake)

#### Table: query_history
```sql
CREATE TABLE query_history (
    query_id VARCHAR PRIMARY KEY,
    sql_text TEXT NOT NULL,
    execution_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    user_id VARCHAR NOT NULL,
    session_id VARCHAR,
    source_tables ARRAY,
    result_row_count INTEGER,
    result_data_hash VARCHAR,
    user_question TEXT,
    INDEX idx_user_timestamp (user_id, execution_timestamp),
    INDEX idx_session (session_id)
);
```

#### Table: query_results
```sql
CREATE TABLE query_results (
    query_id VARCHAR NOT NULL,
    result_data VARIANT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    FOREIGN KEY (query_id) REFERENCES query_history(query_id),
    INDEX idx_created_at (created_at)
);
```

#### Table: response_citations
```sql
CREATE TABLE response_citations (
    response_id VARCHAR PRIMARY KEY,
    user_id VARCHAR NOT NULL,
    session_id VARCHAR,
    response_text TEXT,
    citations ARRAY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
    INDEX idx_user_session (user_id, session_id, created_at)
);
```

### Component Architecture

#### CitationService Class
**Purpose**: Manages citation generation and formatting

**Methods**:
- `add_data_citation(query_id)` → Returns citation marker
- `add_memory_citation(memory_id)` → Returns citation marker  
- `format_footnotes()` → Returns formatted footnote section
- `get_query_source_info(query_id)` → Retrieves source metadata
- `reset()` → Resets citation counter for new response

#### Enhanced Vanna Integration
**Purpose**: Capture query lineage during SQL execution

**Key Changes**:
- Wrap existing Vanna calls with lineage capture
- Store query metadata before execution
- Generate unique query_id for each execution
- Extract table names from SQL using regex/parser

#### Memory Enhancement Module
**Purpose**: Extend Mem0 storage with citation metadata

**New Metadata Fields**:
- `source_query_ids`: Array of originating query IDs
- `referenced_memories`: Array of memory IDs referenced
- `citation_timestamp`: When insight was created
- `data_sources`: Summary of data tables used

---

## Implementation Plan

### Phase 1: Database Setup (Week 1)
**Deliverables**:
- Create Snowflake schema with all tables
- Implement data retention policies
- Set up indexing for performance
- Create database migration scripts

**Tasks**:
1. Design and create table schemas
2. Set up automated cleanup job for 3-month retention
3. Create database access layer functions
4. Test database operations and performance

### Phase 2: Data Lineage Capture (Week 2)
**Deliverables**:
- Enhanced Vanna integration with query capture
- Query execution wrapper functions
- Table name extraction utility
- Unit tests for lineage capture

**Tasks**:
1. Create `QueryCaptureService` class
2. Modify existing Vanna workflow to use wrapper
3. Implement SQL table name extraction
4. Add error handling and logging
5. Test with various SQL query types

### Phase 3: Citation Service Implementation (Week 2-3)
**Deliverables**:
- Complete `CitationService` class
- Citation formatting utilities
- Integration with query history lookup
- Memory citation integration

**Tasks**:
1. Implement core `CitationService` class
2. Create footnote formatting functions
3. Build query metadata retrieval functions
4. Integrate with Mem0 metadata
5. Add comprehensive testing

### Phase 4: Memory Enhancement (Week 3)
**Deliverables**:
- Enhanced Mem0 storage with citation metadata
- Memory linking utilities
- Updated memory retrieval functions
- Migration for existing memories

**Tasks**:
1. Extend Mem0 storage structure
2. Create memory-query linking functions
3. Update existing memory store/retrieve calls
4. Implement backward compatibility
5. Test memory operations with citations

### Phase 5: LLM Integration (Week 3-4)
**Deliverables**:
- Enhanced LLM prompting with citations
- Response generation with citation injection
- Citation marker processing
- Response-citation mapping storage

**Tasks**:
1. Modify LLM prompt templates
2. Create response generation wrapper
3. Implement citation marker injection
4. Store response-citation mappings
5. Test various response scenarios

### Phase 6: Streamlit UI Enhancement (Week 4)
**Deliverables**:
- Footnoted response display
- Expandable citations section
- Citation hover/tooltip functionality
- UI testing and refinement

**Tasks**:
1. Create citation display components
2. Implement expandable footnotes section
3. Add citation number highlighting
4. Style citations for readability
5. Test UI across different response types

### Phase 7: Integration Testing (Week 4)
**Deliverables**:
- End-to-end system testing
- Performance optimization
- Error handling validation
- Documentation updates

**Tasks**:
1. Test complete citation pipeline
2. Validate citation accuracy
3. Performance testing and optimization
4. Error scenario testing
5. Update system documentation

---

## API Specifications

### Enhanced Vanna Function
```python
def enhanced_vanna_query(
    user_question: str, 
    user_id: str, 
    session_id: str
) -> Tuple[pd.DataFrame, str]:
    """
    Execute Vanna query with lineage capture
    
    Returns:
        Tuple of (results_dataframe, query_id)
    """
```

### CitationService API
```python
class CitationService:
    def add_data_citation(self, query_id: str) -> str
    def add_memory_citation(self, memory_id: str) -> str
    def format_footnotes(self) -> str
    def get_citations(self) -> List[Dict]
    def reset(self) -> None
```

### Enhanced Response Generation
```python
def generate_response_with_citations(
    user_question: str,
    fresh_data: Optional[Dict] = None,
    memories: Optional[List[Dict]] = None,
    user_id: str,
    session_id: str
) -> str:
    """
    Generate LLM response with embedded citations
    
    Returns:
        Complete response with footnotes
    """
```

---

## Testing Strategy

### Unit Testing
- **Database Operations**: Test all CRUD operations on citation tables
- **Citation Service**: Test citation generation and formatting
- **Query Capture**: Test SQL parsing and metadata extraction
- **Memory Enhancement**: Test Mem0 integration with citations

### Integration Testing
- **End-to-End Pipeline**: Test complete user question → cited response flow
- **Vanna Integration**: Test SQL generation and execution with capture
- **Memory Integration**: Test citation retrieval from stored memories
- **UI Integration**: Test Streamlit display of cited responses

### Performance Testing
- **Response Time**: Measure citation overhead on response generation
- **Database Performance**: Test query performance with citation lookups
- **Memory Usage**: Monitor memory consumption with citation data
- **Concurrent Users**: Test system under multiple simultaneous users

### User Acceptance Testing
- **Citation Accuracy**: Verify citations point to correct sources
- **UI Usability**: Test footnote display and interaction
- **Response Quality**: Ensure citations don't degrade response quality
- **Error Handling**: Test graceful degradation when citations fail

---

## Configuration

### Environment Variables
```python
# Database Configuration
SNOWFLAKE_CITATION_SCHEMA = "citations"
CITATION_RETENTION_MONTHS = 3

# Citation Service Settings  
MAX_FOOTNOTES_PER_RESPONSE = 10
CITATION_TIMEOUT_SECONDS = 5

# UI Configuration
SHOW_CITATION_TOOLTIPS = true
EXPAND_FOOTNOTES_DEFAULT = false
```

### Feature Flags
```python
ENABLE_CITATIONS = true
ENABLE_DATA_CITATIONS = true  
ENABLE_MEMORY_CITATIONS = true
FALLBACK_WITHOUT_CITATIONS = true
```

---

## Monitoring & Alerts

### Key Metrics
- **Citation Coverage**: Percentage of responses with citations
- **Citation Accuracy**: Manual validation of citation correctness
- **Performance Impact**: Response time increase due to citations
- **Storage Growth**: Citation data storage consumption
- **Error Rate**: Citation system failures per day

### Alerts
- **High Error Rate**: >5% citation failures in 1 hour
- **Performance Degradation**: >1s average citation lookup time
- **Storage Threshold**: Citation tables >80% of allocated space
- **Data Retention**: Failed cleanup jobs for >24 hours

---

## Rollout Plan

### Phase 1: Internal Testing (Week 5)
- Deploy to development environment
- Internal team testing and feedback
- Performance validation
- Bug fixes and refinements

### Phase 2: Limited Beta (Week 6)
- Deploy to staging with subset of users
- Monitor citation accuracy and performance
- Gather user feedback on citation usefulness
- Iterate on UI and citation formats

### Phase 3: Full Production (Week 7)
- Deploy to production environment
- Monitor all metrics and alerts
- Gradual rollout to all users
- Documentation and training materials

---

## Success Metrics

### Primary KPIs
- **User Trust**: Survey responses on information credibility (+20%)
- **Citation Usage**: Users clicking/expanding footnotes (>30% of responses)
- **System Reliability**: Citation system uptime (>99.5%)
- **Performance**: No degradation in overall response time

### Secondary KPIs  
- **Data Quality**: Reduction in user questions about data sources (-50%)
- **Memory Utilization**: Increased reference to previous insights (+25%)
- **Developer Velocity**: Time to implement new citation types
- **User Satisfaction**: Overall chatbot rating improvement

---

## Risks & Mitigations

### Technical Risks
- **Performance Impact**: Citations slow down responses
  - *Mitigation*: Implement caching and async citation lookup
- **Storage Costs**: Citation data increases Snowflake usage
  - *Mitigation*: Optimize retention policies and data compression
- **Integration Complexity**: Citations break existing workflows
  - *Mitigation*: Implement feature flags and graceful degradation

### Business Risks
- **User Confusion**: Too many citations overwhelm users
  - *Mitigation*: Limit citations per response and improve UI
- **Data Privacy**: Citations expose sensitive query patterns
  - *Mitigation*: Implement citation access controls and audit logs
- **Maintenance Overhead**: Citation system requires ongoing maintenance
  - *Mitigation*: Comprehensive monitoring and automated testing

---

## Future Enhancements

### Phase 2 Features (Future)
- **Interactive Citations**: Click to view original data/query
- **Citation Confidence**: Score citation reliability/freshness
- **Smart Citations**: ML-driven citation relevance scoring
- **Citation Analytics**: Track which citations users find most valuable

### Integration Opportunities
- **Export with Citations**: Include citations in report exports
- **Citation API**: External access to citation metadata
- **Citation Notifications**: Alert when cited data changes
- **Multi-modal Citations**: Support for chart/visualization citations